#!/bin/bash
set -e
SAY="Production version published"
URL="https://github.com/intergestalt/MareeLettres.git"
PROJECT_NAME="MareeLettres"
EXPO_ACCOUNT="mareedeslettres"
command=`basename "$0"`
command_path_full=`realpath "$0"`
command_path=`dirname "$command_path_full"`

if [ $# -eq 0 ]
  then
    echo "Usage: $command <Git Version Hash (sha1) or Tag>"
    exit
fi

SHA1=$1
echo "Version: $SHA1"

# clean
cd $TMPDIR
rm -rf $PROJECT_NAME

# get code
git clone $URL
cd $PROJECT_NAME
git reset --hard $SHA1

# build
cd shared/maree-lettres-shared
yarn install
yarn build
cd ../../
cd react-native
yarn install

# modify server
$command_path/patch_server_app_json `pwd`/app.json production
cat app.json

# publish
exp logout
exp login -u mareedeslettres
exp publish
exp logout

exit;

# clean
cd $TMPDIR
rm -rf $PROJECT_NAME

# success
say -v Tom $SAY || say $SAY